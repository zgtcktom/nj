<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ndoffset.mjs</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ndoffset.mjs</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { arange, slice, tester } from './core.mjs';

class Ndoffset {
	/**
	 *
	 * @param {number[]} shape
	 * @param {number[]} strides
	 * @param {number} initial
	 */
	constructor(shape, strides, initial) {
		let ndim = shape.length;
		this.ndim = ndim;

		this.shape = shape;
		this.strides = strides;

		let dim_strides = Array(ndim);
		for (let i = 0; i &lt; ndim; i++) {
			dim_strides[i] = shape[i] * strides[i];
		}
		this.dim_strides = dim_strides;

		this.initial = initial;

		let size = 1;
		for (let dim of shape) {
			size *= dim;
		}
		this.size = size;

		this.coords = Array(ndim);
		this.reset();
	}

	[Symbol.iterator]() {
		this.reset();
		return this;
	}

	reset() {
		this.coords.fill(0);
		this.index = 0;
		this.offset = this.initial;
		this.done = this.size == 0;
	}

	/**
	 *
	 * @returns {{value: number, done: boolean}}
	 */
	next() {
		// micro-optimized
		if (this.done) return { done: true };

		let { offset, coords, shape, strides, ndim, dim_strides, size } = this;

		let value = offset;

		let ptr = ndim - 1;
		let carry = true;
		while (ptr >= 0) {
			let dim = shape[ptr];
			if (dim == 1) {
				ptr--;
			} else if (dim == coords[ptr]) {
				offset -= dim_strides[ptr];
				coords[ptr--] = 0;
				carry = true;
			} else {
				if (!carry) break;
				offset += strides[ptr];
				coords[ptr] += 1;
				carry = false;
			}
		}

		this.offset = offset;
		this.done = ++this.index >= size;

		return { value, done: false };
	}
}

/**
 *
 * @param {number[]} shape
 * @param {number[]} strides
 * @param {number} initial
 * @returns {Ndoffset}
 */
export function ndoffset(shape, strides, initial = 0) {
	return new Ndoffset(shape, strides, initial);
}

tester.add(
	ndoffset,
	() => {
		let a = arange(100);
		a = a.get(slice(20, -20)).reshape([2, 1, -1, 2]).get(slice('...'), slice('::-1'));
		let flatten = [];
		for (let offset of ndoffset(a.shape, a.strides)) {
			flatten.push(a.data[a.offset + offset]);
		}
		return flatten;
	},
	() => [
		21, 20, 23, 22, 25, 24, 27, 26, 29, 28, 31, 30, 33, 32, 35, 34, 37, 36, 39, 38, 41, 40, 43, 42, 45,
		44, 47, 46, 49, 48, 51, 50, 53, 52, 55, 54, 57, 56, 59, 58, 61, 60, 63, 62, 65, 64, 67, 66, 69, 68,
		71, 70, 73, 72, 75, 74, 77, 76, 79, 78,
	]
);

// tester.onload(() => {
// 	let a = arange(100);
// 	a = a.get(slice(20, -20)).reshape([2, 1, -1, 2]).get(slice('...'), slice('::-1'));

// 	console.log(ndoffset(a.shape, a.strides, a.offset));
// 	console.log([...ndoffset(a.shape, a.strides, a.offset)]);
// });
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="FloatingFormat.html">FloatingFormat</a></li><li><a href="IntegerFormat.html">IntegerFormat</a></li><li><a href="NDArray.html">NDArray</a></li><li><a href="Ndoffset.html">Ndoffset</a></li><li><a href="Slice.html">Slice</a></li><li><a href="SliceIterator.html">SliceIterator</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_array2string">_array2string</a></li><li><a href="global.html#_extendLine">_extendLine</a></li><li><a href="global.html#_extendLine_pretty">_extendLine_pretty</a></li><li><a href="global.html#_formatOptions">_formatOptions</a></li><li><a href="global.html#_get_formatdict">_get_formatdict</a></li><li><a href="global.html#_leading_trailing">_leading_trailing</a></li><li><a href="global.html#arange">arange</a></li><li><a href="global.html#array">array</a></li><li><a href="global.html#array2string">array2string</a></li><li><a href="global.html#array_repr">array_repr</a></li><li><a href="global.html#array_str">array_str</a></li><li><a href="global.html#asarray">asarray</a></li><li><a href="global.html#atleast_1d">atleast_1d</a></li><li><a href="global.html#atleast_2d">atleast_2d</a></li><li><a href="global.html#atleast_3d">atleast_3d</a></li><li><a href="global.html#copyto">copyto</a></li><li><a href="global.html#default_format">default_format</a></li><li><a href="global.html#dtype">dtype</a></li><li><a href="global.html#empty">empty</a></li><li><a href="global.html#full">full</a></li><li><a href="global.html#matmul">matmul</a></li><li><a href="global.html#ndenumerate">ndenumerate</a></li><li><a href="global.html#ndim">ndim</a></li><li><a href="global.html#ndindex">ndindex</a></li><li><a href="global.html#ndoffset">ndoffset</a></li><li><a href="global.html#nested_shape">nested_shape</a></li><li><a href="global.html#nonzero">nonzero</a></li><li><a href="global.html#positional">positional</a></li><li><a href="global.html#scientific">scientific</a></li><li><a href="global.html#shape">shape</a></li><li><a href="global.html#slice">slice</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Tue Apr 18 2023 12:37:19 GMT+0800 (Hong Kong Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
